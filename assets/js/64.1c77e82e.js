(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{563:function(e,t,a){"use strict";a.r(t);var i=a(26),n=Object(i.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"payjoin-implementation-notes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#payjoin-implementation-notes"}},[e._v("#")]),e._v(" Payjoin implementation notes")]),e._v(" "),a("h2",{attrs:{id:"introduction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[e._v("#")]),e._v(" Introduction")]),e._v(" "),a("p",[e._v("Payjoin is a generic term for any privacy mechanism where merchants can protect their own and the privacy of their customers by mixing merchant's UTXOs with customer's payment.")]),e._v(" "),a("p",[e._v("This has two purposes:")]),e._v(" "),a("ul",[a("li",[e._v("It protects the sender by fighting against one of the biggest heuristic used by privacy invading technology: No longer can it be assumed that all the inputs in a transaction belongs to the same entity")]),e._v(" "),a("li",[e._v("It allows the receiver to consolidate UTXOs and "),a("a",{attrs:{href:"#batching"}},[e._v("batch")]),e._v(" his own payments to economize on-chain fee.")])]),e._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki",target:"_blank",rel:"noopener noreferrer"}},[e._v("Bustapay (BIP79)"),a("OutboundLink")],1),e._v(" is a specification of such mechanism and has been the first attempt to properly standardize it.")]),e._v(" "),a("p",[e._v("However, we identified some issues in the Bustapay specification, so we needed to deviate from it.")]),e._v(" "),a("p",[e._v("This document attempts at describing the protocol BTCPay Server is using, along with our implementation choices and rationale behind all of them.")]),e._v(" "),a("p",[e._v("Not only the will allow additional wallets to interoperate with us more easily, but this provides a way to get feedback from the community of things we may have overlooked. We may submit this protocol as a Bitcoin Improvement Proposal once we are confident nothing is missing.")]),e._v(" "),a("h2",{attrs:{id:"in-a-nutshell"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#in-a-nutshell"}},[e._v("#")]),e._v(" In a nutshell")]),e._v(" "),a("p",[e._v("We are using the same one step process as "),a("a",{attrs:{href:"https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki",target:"_blank",rel:"noopener noreferrer"}},[e._v("bustapay (BIP79)"),a("OutboundLink")],1),e._v(", where the sender is creating a PSBT (or transaction) called the "),a("code",[e._v("original transaction")]),e._v(", which is a valid payment which can be broadcasted by the receiver as-is if the payjoin fails.")]),e._v(" "),a("p",[e._v("If a payjoin is possible, the receiver sends back a "),a("code",[e._v("payjoin transaction proposal")]),e._v(" which represents a transaction or PSBT signed by the receiver. Such proposal includes additional inputs or outputs from the receiver.")]),e._v(" "),a("p",[e._v("The sender validates this "),a("code",[e._v("payjoin transaction proposal")]),e._v(", signs it and broadcasts the resulting valid "),a("code",[e._v("payjoin transaction")]),e._v(".")]),e._v(" "),a("h2",{attrs:{id:"difference-with-bustapay"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#difference-with-bustapay"}},[e._v("#")]),e._v(" Difference with Bustapay")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki",target:"_blank",rel:"noopener noreferrer"}},[e._v("bustapay (BIP79)"),a("OutboundLink")],1),e._v(" proposal has been written as a proposal protocol for payjoin.")]),e._v(" "),a("p",[e._v("We initially implemented it, but found out that the specification was missing certain important aspects.\nAlso, because this is a new proposal, we expect that even our own proposal will experience breaking changes in the short-term.\nAs such, we preferred writing our own specification for the time being.\nOnce the specification stabilizes and has gone through review and testing by the community, we will decide whether we will submit to the BIP process, or if we can just modify bustapay BIP79.")]),e._v(" "),a("p",[e._v("Bustapay is currently not widely deployed, so we are not worried about breaking backwards compatibility.")]),e._v(" "),a("p",[e._v("Our implementation is identical to bustapay with the following differences.")]),e._v(" "),a("div",{staticClass:"language-diff extra-class"},[a("pre",{pre:!0,attrs:{class:"language-diff"}},[a("code",[a("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e._v('- The standard way of letting a sender know where to send a bustapay transaction is done via a bip21 encoded address. The key value "bpu" (short for "BustaPayUrl") should be used. An example of such address would be bitcoin:2NABbUr9yeRCp1oUCtVmgJF8HGRCo3ifpTT?bpu=https://bp.bustabit.com/submit It is highly encouraged that urls are kept short.\n')]),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e._v('+ The standard way of letting a sender know where to send a bustapay transaction is done via a bip21 encoded address. The key value "pj" (short for "payjoin URL") should be used. An example of such address would be bitcoin:2NABbUr9yeRCp1oUCtVmgJF8HGRCo3ifpTT?pj=https://example.com/submit It is highly encouraged that urls are kept short.\n')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e._v("- Step 1. Sender creates a bitcoin transaction paying the receiver\n")]),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e._v("+ Step 1. Sender creates a bitcoin transaction OR PSBT paying the receiver\n+ While we also support the use of raw transaction instead of PSBT, we strongly advise against it.\n")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e._v("- This transaction must use segwit for all inputs, and be fully valid and signed. The transaction must be eligible for propagation on the network (but not done so at this stage)\n")]),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e._v("+ If using PSBT, the PSBT must be finalized with witness UTXO information.\n+ If using transactions, the transaction must use segwit for all inputs, and be fully valid and signed. The transaction must be eligible for propagation on the network (but not done so at this stage\n")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e._v('- Step 2. Sender gives the "template transaction" to the receiver\n')]),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e._v('+ Step 2. If using PSBT, sender gives "original PSBT" to the receiver, in base64 or hex format.\n+ If using transactions, sender gives "original transaction" to the receiver, in hex format.\n')]),a("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e._v('- This is done via an HTTP POST request, sent to a "[bustapay] url"\n')]),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e._v('+ This is done via an HTTP POST request, sent to a "[payjoin] url"\n')]),e._v("\nStep 3. Receiver processes the transaction and returns a partially signed coinjoin\n\n"),a("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e._v("- The receiver validates the transaction, and pays himself. The receiver then adds one or more of his own inputs (known as the contributed inputs) and (optionally) increases the output that pays himself (generally by the sum of the contributed inputs). Doing so creates a partial transaction, which the receiver returns to the sender. It is called such as it requires the sender to re-sign his own inputs.\n")]),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e._v('+ The receiver extracts the transaction, optionally verifying it is valid. (by calling testmempoolaccept on the extracted transaction)\n+ The receiver extracts the feerate, adds one of his inputs and decreases the change output of the payer by the increased fee difference his input added such that the feerate is the same as the "orginal PSBT" or "original transaction".\n')])])])]),a("p",[e._v("The rest of the process is similar to bustapay.")]),e._v(" "),a("p",[e._v("We will refer to the sender's PSBT by the name of "),a("code",[e._v("original PSBT")]),e._v(" and the receiver's payjoin proposal as "),a("code",[e._v("payjoin PSBT")]),e._v(".")]),e._v(" "),a("p",[e._v("There is no guarantee concerning the ordering of outputs and inputs in either the "),a("code",[e._v("original PSBT")]),e._v(" or the "),a("code",[e._v("payjoin PSBT")]),e._v(". (Note about "),a("RouterLink",{attrs:{to:"/Payjoin-spec.html#increasing-privacy-of-clients-using-bip69"}},[e._v("BIP69")]),e._v(")")],1),e._v(" "),a("p",[e._v("Note: We strongly recommend the sender to submit a PSBT in Base64 format.\nHowever, we also accept the PSBT or a bitcoin transaction in hex format.")]),e._v(" "),a("h2",{attrs:{id:"rationale"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rationale"}},[e._v("#")]),e._v(" Rationale")]),e._v(" "),a("p",[e._v("Here is the rationale for using PSBT instead of raw transactions, and why the receiver should be responsible to bump the fee of the payjoin transaction.")]),e._v(" "),a("h3",{attrs:{id:"respecting-the-minimum-relay-fee-policy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#respecting-the-minimum-relay-fee-policy"}},[e._v("#")]),e._v(" Respecting the minimum relay fee policy")]),e._v(" "),a("p",[e._v("To be properly relayed, a Bitcoin transaction needs to pay at least 1 satoshi per virtual byte.\nWhen fees are low, the original transaction is already 1 satoshi per virtual byte, so if the merchant adds their own input, they need to make sure the fee is increased such that the rate does not drop below 1 satoshi per virtual byte.")]),e._v(" "),a("h3",{attrs:{id:"preventing-mempool-replacement"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#preventing-mempool-replacement"}},[e._v("#")]),e._v(" Preventing mempool replacement")]),e._v(" "),a("p",[e._v("A safe way to implement payjoin, is for both the sender and receiver to try broadcasting the original transaction at some fixed interval period regardless of the state of the payjoin.")]),e._v(" "),a("p",[e._v("If the receiver was not properly adding fees to the payjoin transaction, the original transaction would end up replacing the payjoin transaction in the mempool.")]),e._v(" "),a("h3",{attrs:{id:"defeating-heuristics-based-on-the-fee-calculation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#defeating-heuristics-based-on-the-fee-calculation"}},[e._v("#")]),e._v(" Defeating heuristics based on the fee calculation")]),e._v(" "),a("p",[e._v("Most wallets are creating a round fee rate (like 2 sat/b).\nIf the payjoin transaction's fee was not increased by the added size, then those payjoin transaction could easily be identifiable on the blockchain.")]),e._v(" "),a("p",[e._v("Not only would those transactions would stand out by not having a round fee (like 1.87 sat/b), but any suspicion of payjoin could be confirmed by checking if removing one input would create a round fee rate.")]),e._v(" "),a("h3",{attrs:{id:"receiver-does-not-need-to-be-a-full-node"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#receiver-does-not-need-to-be-a-full-node"}},[e._v("#")]),e._v(" Receiver does not need to be a full node")]),e._v(" "),a("p",[e._v("Because the receiver needs to bump the fee to keep the same fee rate as the original PSBT, it needs the input's UTXO information to know what is the original fee rate. Without PSBT, light wallets like Wasabi Wallet would not be able to receive a payjoin transaction.")]),e._v(" "),a("p",[e._v("The validation (policy and consensus) of the original transaction is optional: a receiver without a full node can decide to create the payjoin transaction and automatically broadcast the original transaction after a timeout of 1 minute, and only verifying that it has been propagated in the network.")]),e._v(" "),a("p",[e._v("However, automated systems (like BTCPay Server) need to verify the transaction to prevent UTXO probing attacks.")]),e._v(" "),a("p",[e._v("This is not a concern for receivers using end-user wallets such as Wasabi Wallet, such receivers can just limit the number of original PSBT proposals of a specific address to one. With such wallets, the attacker has no way to generate new deposit addresses to probe the UTXOs.")]),e._v(" "),a("h2",{attrs:{id:"implementation-notes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#implementation-notes"}},[e._v("#")]),e._v(" Implementation notes")]),e._v(" "),a("h3",{attrs:{id:"receiver-side"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#receiver-side"}},[e._v("#")]),e._v(" Receiver side")]),e._v(" "),a("p",[e._v("The BTCPay Server implementation is making the following checks on the original PSBT:")]),e._v(" "),a("ul",[a("li",[e._v("The original PSBT must be finalized (Fails with error "),a("code",[e._v("psbt-not-finalized")]),e._v(")")]),e._v(" "),a("li",[e._v("All the inputs must be P2WPKH or P2SH-P2WPKH and only if the the store has utxos that match the original tx inputs (Fails with error "),a("code",[e._v("unsupported-inputs")]),e._v(") "),a("a",{attrs:{href:"#unsupported-inputs"}},[e._v("*")])]),e._v(" "),a("li",[e._v("The PSBT is sane (Fails with error "),a("code",[e._v("insane-psbt")]),e._v(")")]),e._v(" "),a("li",[e._v("All inputs have the "),a("code",[e._v("witnessUTXO")]),e._v(" (Fails with error "),a("code",[e._v("need-utxo-information")]),e._v(")")]),e._v(" "),a("li",[e._v("Check that there is no global xpubs, HD Key or public key information in the PSBT (Fails with error "),a("code",[e._v("leaking-data")]),e._v(")")]),e._v(" "),a("li",[e._v("Check that the extracted transaction can be accepted by mempool (Fails with error "),a("code",[e._v("invalid-transaction")]),e._v(")")])]),e._v(" "),a("p",[e._v("Then the original PSBT is deemed valid, however, other checks are done which depends on the state of the receiver's state.")]),e._v(" "),a("ul",[a("li",[e._v("Check that it pays an actual invoice (Fails with error "),a("code",[e._v("invoice-not-found")]),e._v(")")]),e._v(" "),a("li",[e._v("Check that the invoice does not have any outstanding payment (Fails with error "),a("code",[e._v("already-paid")]),e._v(")")]),e._v(" "),a("li",[e._v("Check that the whole amount of the invoice is paid (Fails with error "),a("code",[e._v("invoice-not-fully-paid")]),e._v(")")]),e._v(" "),a("li",[e._v("Check that the inputs used in the original PSBT have never been used for another payjoin (Fails with "),a("code",[e._v("inputs-already-used")]),e._v(")")]),e._v(" "),a("li",[e._v("Check that the receiver has available UTXO to contribute to the payjoin (Fails with error "),a("code",[e._v("out-of-utxos")]),e._v(", the receiver will broadcast the original transaction)")]),e._v(" "),a("li",[e._v("Check that the receiver can actually sign (Fails with error "),a("code",[e._v("unavailable")]),e._v(")")])]),e._v(" "),a("p",[e._v("From this point, the receiver will automatically try to broadcast the original transaction after 1 minute, whatever happens.\nThen, we proceed to create the payjoin transaction by cloning the original transaction:")]),e._v(" "),a("ul",[a("li",[e._v("If there is only one output, we add a second output "),a("a",{attrs:{href:"#spare-change"}},[e._v("*")])]),e._v(" "),a("li",[e._v("We include some of the receiver's inputs")])]),e._v(" "),a("p",[e._v("Finally, we need to increase the fees to pay for the increased size of the payjoin transaction to pay for additional inputs and outputs of the receiver.")]),e._v(" "),a("ul",[a("li",[e._v("If the sender overpaid the invoice, we substract fees on the overpaid part of the output paying the invoice. "),a("a",{attrs:{href:"#receiver-pay"}},[e._v("**")])]),e._v(" "),a("li",[e._v("We substract the rest to other outputs that we assume are change outputs, making sure their value does not go below dust.")]),e._v(" "),a("li",[e._v("If there is not enough money to pay for the increased fee, check that the fee rate of the payjoin transaction is above the minimum relay fee (today 1 satoshi per byte). If not, fails with error "),a("code",[e._v("not-enough-money")]),e._v(".")])]),e._v(" "),a("p",[e._v("From this point, we consider the invoice "),a("code",[e._v("paid")]),e._v(" in BTCPay Server. As the receiver can broadcast the original transaction at any time. It appears in the invoice details as a transaction with "),a("code",[e._v("-1")]),e._v(" confirmations. (That is, a transaction not yet broadcasted but still accounted for)")]),e._v(" "),a("p",[e._v("We then send the payjoin transaction proposal back to the sender.")]),e._v(" "),a("p",[e._v("* "),a("a",{attrs:{name:"unsupported-inputs"}}),e._v(": We currently only support receivers and senders using P2WPKH or P2SH-P2WPKH, while we plan to relax this in a later release, it is important for the receiver to use the same input's type as the sender, otherwise the payjoin transaction would provide no privacy benefit. Since most wallets do not support P2WSH or wrapped P2WSH for the sender, we decided to not offer this feature for now.")]),e._v(" "),a("p",[e._v("** "),a("a",{attrs:{name:"receiver-pay"}}),e._v(": If the sender overpays the invoice, we can substract fees from his over paid amount. This is especially useful when somebody wants to make a donation from a small unspent output in his own wallet the amount of his change may be overpaying the invoice. If we were not substracting the fees on the output paying the invoice, we would fall into a "),a("code",[e._v("not-enough-money")]),e._v(" error, as no change exists.")]),e._v(" "),a("h3",{attrs:{id:"sender-side"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sender-side"}},[e._v("#")]),e._v(" Sender side "),a("a",{attrs:{name:"sender"}})]),e._v(" "),a("p",[e._v("Before sending the original PSBT to the receiver, the sender should make sure that the original PSBT is at least attempted to be broadcasted automatically after 1 minute of submission.")]),e._v(" "),a("p",[e._v("The sender then follows the steps:")]),e._v(" "),a("ul",[a("li",[e._v("Check that the payjoin PSBT must not contain global xpub, hd key path or public key information.")]),e._v(" "),a("li",[e._v("Check that the PSBT is sane.")]),e._v(" "),a("li",[e._v("Check that all the spent outpoints in the original PSBT still exists in the coinjoin PSBT.")]),e._v(" "),a("li",[e._v("Check that all the spent outpoints in the original PSBT does not have any partial signature.")]),e._v(" "),a("li",[e._v("Check that the receiver added at least one input.")]),e._v(" "),a("li",[e._v("Check that the receiver added P2WPKH or P2SH-P2WPKH inputs.")]),e._v(" "),a("li",[e._v("Check that the receiver inputs type match the inputs type of the sender. (ie. both using P2SH-P2WPKH or both using P2WPKH)")]),e._v(" "),a("li",[e._v("Check that any other outpoints (those added by the receiver) are finalized.")]),e._v(" "),a("li",[e._v("Check that the transaction version, and nLockTime are unchanged.")]),e._v(" "),a("li",[e._v("Check that the sender's input's sequence numbers are unchanged.")]),e._v(" "),a("li",[e._v("Update "),a("code",[e._v("WitnessUTXO")]),e._v(" of the PSBT.")]),e._v(" "),a("li",[e._v("Fill out only the HD Key paths and public keys of inputs and outputs that were present in the original PSBT.")]),e._v(" "),a("li",[e._v("Check that the sent amount in the payjoin transaction is the same as the sent amount of the original transaction. "),a("a",{attrs:{href:"#calculate-balance"}},[e._v("*")])]),e._v(" "),a("li",[e._v("If those are different:\n"),a("ul",[a("li",[e._v("Check that the additional paid amount is not more than the additional fee paid in the payjoin transaction.")]),e._v(" "),a("li",[e._v("Check that the additional paid amount is not more than twice the original fee")]),e._v(" "),a("li",[e._v("Check that the additional paid amount is not more than the expected fee once the payjoin transaction is fully signed "),a("a",{attrs:{href:"#calculate-increased-fee"}},[e._v("**")])])])])]),e._v(" "),a("p",[e._v("After all those checks, the sender can proceed to sign the payjoin transaction.")]),e._v(" "),a("p",[e._v("Our client is able to pay a onion payjoin endpoint, this will allow wallets hosted on BTCPay Server to pay desktop or mobile wallets without any NAT configuration.")]),e._v(" "),a("p",[e._v("Note:")]),e._v(" "),a("ul",[a("li",[e._v("The sender "),a("strong",[e._v("does NOT check")]),e._v(" whether ouputs have been removed or modified. This allows flexibility to the receiver to adapt his receiving address type to match the other outputs's address type of the sender, or, on the contrary, to create a payment output which would be considered a change address by common chain analysis heuristic. For example, if the receiver supports both P2WPKH and P2SH-P2WPKH, even if the invoice's address in the original transaction was P2WPKH, the receiver may change the address to be P2SH-P2WPKH to match sender's change address format. This is safe because the sender only cares that they do not send too much money in the payjoin transaction. It is also useful if the receiver wants to batch some of their own payments in the transaction.")]),e._v(" "),a("li",[e._v("Our method of checking fee allows the receiver to batch payments in the payjoin transaction as long as they pay the fee above the sender's expected amount. (See "),a("RouterLink",{attrs:{to:"/Payjoin-spec.html#receivers-payment-batching"}},[e._v("batching")]),e._v(")")],1)]),e._v(" "),a("p",[e._v("*"),a("a",{attrs:{name:"calculate-balance"}}),e._v(": For calculating the sent amount of the payjoin transaction, you must only include in the calculation the inputs and outputs that were also present in the original PSBT. (in other words, those with HD key paths and public keys set)")]),e._v(" "),a("p",[e._v("**"),a("a",{attrs:{name:"calculate-increased-fee"}}),e._v(": To calculate the expected fee once the payjoin transaction is fully signed, we estimate its virtual size and multiply by the fee rate of the original transaction, then we add: "),a("code",[e._v("fee_rate * 2 * input_count")]),e._v(". This allow small error of fee estimation and account for outputs that may have been removed if they ended up below dust.")]),e._v(" "),a("h2",{attrs:{id:"other-considerations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#other-considerations"}},[e._v("#")]),e._v(" Other considerations")]),e._v(" "),a("h3",{attrs:{id:"analysis-poisoning"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#analysis-poisoning"}},[e._v("#")]),e._v(" Analysis poisoning")]),e._v(" "),a("p",[e._v("Malicious entities often send very small amounts of bitcoin to used, tainted addresses in an effort to deanonymise the receiver.")]),e._v(" "),a("p",[e._v("For example if Mallory knows that address A belongs to Bob, and Mallory wants to know the other unspent outputs of Bob, she can send 1000 satoshi to address A.\nThen Bob would eventually make a payment including this unspent output and other unspent output B and C. Mallory could learn from this that B and C belongs to Bob.")]),e._v(" "),a("p",[e._v("However, if Bob is suspicious about those 1000 satoshi and knows about Mallory attempts to deanonymise him, Bob can decide to send those 1000 satoshi to Alice in a payjoin transaction. Mallory would then have her analysis poisoned with the mistaken belief that some of Alice's unspent output belong to Bob.")]),e._v(" "),a("p",[e._v("Another example of analysis poisoning is explained in "),a("RouterLink",{attrs:{to:"/Payjoin-spec.html#blockchain-analytics-heuristics-affected-by-our-implementation"}},[e._v("the following section")]),e._v(".")],1),e._v(" "),a("h3",{attrs:{id:"spare-change-donation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#spare-change-donation"}},[e._v("#")]),e._v(" Spare change donation "),a("a",{attrs:{name:"spare-change"}})]),e._v(" "),a("p",[e._v("Small change inside wallets are detrimental to privacy. Mixers like Wasabi wallet, because of its protocol, eventually generate such "),a("a",{attrs:{href:"https://docs.wasabiwallet.io/using-wasabi/ChangeCoins.html#spend-the-change-with-another-entity-where-you-don-t-mind-if-each-of-the-two-know-that-you-transact-with-the-other-entity",target:"_blank",rel:"noopener noreferrer"}},[e._v("small change"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("A common way to protect your privacy is to donate those spare changes to your favorite developer (ie Nicolas Dorier), to deposit them in an exchange or on your favorite merchant's store account. Those kind of transactions can easily be spotted on the blockchain: There is only one output.")]),e._v(" "),a("p",[e._v("However, if you donate via payjoin, it will look like a normal transaction.")]),e._v(" "),a("p",[e._v("On top of this we poison analysis by randomly faking a round amount of satoshi for the additional output. (See "),a("RouterLink",{attrs:{to:"/Payjoin-spec.html#blockchain-analytics-heuristics-affected-by-our-implementation"}},[e._v("the heuristic section")]),e._v(")")],1),e._v(" "),a("h3",{attrs:{id:"blockchain-analytics-heuristics-affected-by-our-implementation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#blockchain-analytics-heuristics-affected-by-our-implementation"}},[e._v("#")]),e._v(" Blockchain analytics heuristics affected by our implementation "),a("a",{attrs:{name:"heuristics"}})]),e._v(" "),a("p",[e._v("Our implementation of payjoin is breaking the following blockchain heuristics:")]),e._v(" "),a("ul",[a("li",[e._v("Common inputs heuristics.")])]),e._v(" "),a("p",[e._v("Because payjoin is mixing the inputs of the sender and receiver, this heuristic becomes unreliable.")]),e._v(" "),a("ul",[a("li",[e._v("Change identification from scriptPubKey type heuristics.")])]),e._v(" "),a("p",[e._v("When Alice pays Bob, if Alice is using P2SH but Bob's deposit address is P2WPKH, the heuristic would assume that the P2SH output is the change address of Alice.\nThis is now however a broken assumption, as the payjoin receiver has the freedom to mislead analytics by purposefully changing the invoice's address in the payjoin transaction.")]),e._v(" "),a("p",[e._v("If Bob's original address is P2WPKH and Alice is sending from P2SH, then Bob can change the receiving address in the payjoin transaction to be P2SH, preventing the use of this heuristic.")]),e._v(" "),a("p",[e._v("Alternatively, if the original address of Bob is P2WPKH and Alice is also P2WPKH, Bob can change the receiving address in the payjoin to P2SH. The heuristic would wrongfully identify the payjoin's receiving address as the change address of the transaction.")]),e._v(" "),a("ul",[a("li",[e._v("Change identification from round change amount")])]),e._v(" "),a("p",[e._v("If Alice pays Bob, she might be tempted to pay him a round amount, like "),a("code",[e._v("1.23000000 BTC")]),e._v(". When this happens, blockchain analysis often identify the output without the round amount as the change of the transaction.")]),e._v(" "),a("p",[e._v("For this reason, during a "),a("RouterLink",{attrs:{to:"/Payjoin-spec.html#spare-change-donation"}},[e._v("spare change")]),e._v(" situation, we randomly round the amount in the output added by the receiver to the payjoin transaction.")],1),e._v(" "),a("h2",{attrs:{id:"risks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#risks"}},[e._v("#")]),e._v(" Risks")]),e._v(" "),a("h3",{attrs:{id:"on-the-receiver-side-utxo-probing-attack"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#on-the-receiver-side-utxo-probing-attack"}},[e._v("#")]),e._v(" On the receiver side: UTXO probing attack")]),e._v(" "),a("p",[e._v("When the receiver creates a payjoin proposal, they expose one or more inputs belonging to them.")]),e._v(" "),a("p",[e._v("An attacker could create multiple original transactions in order to learn the UTXOs of the receiver, while not broadcasting the payjoin proposal.")]),e._v(" "),a("p",[e._v("While we cannot prevent this type of attack entirely, we implemented the following mitigations:")]),e._v(" "),a("ul",[a("li",[e._v("When the receiver detects an original transaction being broadcasted, or if the receiver detects that the original transaction has been double spent, then they will reuse the UTXO that was exposed for the next payjoin.")]),e._v(" "),a("li",[e._v("Only a single payjoin is possible per invoice.")]),e._v(" "),a("li",[e._v("While the exposed UTXO will be reused in priority to not leak other UTXOs, there is no strong guarantee about it. This prevents the attacker from detecting with certainty the next payjoin of the merchant to another peer.")])]),e._v(" "),a("p",[e._v("Note that probing attacks are only a problem for automated payment systems such as BTCPay Server. End-user wallets with payjoin capabilities are not affected, as the attacker can't create multiple invoices to force the receiver to expose their UTXOs.")]),e._v(" "),a("h3",{attrs:{id:"on-the-sender-side-double-payment-risk-for-hardware-wallets"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#on-the-sender-side-double-payment-risk-for-hardware-wallets"}},[e._v("#")]),e._v(" On the sender side: Double payment risk for hardware wallets")]),e._v(" "),a("p",[e._v("For a successful payjoin to happen, the sender needs to sign two transactions double spending each other: The original transaction and the payjoin proposal.")]),e._v(" "),a("p",[e._v("BTCPay Server or end user wallets can verify that the payjoin proposal is legitimate by following "),a("RouterLink",{attrs:{to:"/Payjoin-spec.html#sender-side"}},[e._v("the sender's steps explained earlier")]),e._v(".")],1),e._v(" "),a("p",[e._v("However, a hardware wallet can't verify that this is indeed the case. This means that the security guarantee of the hardware wallet is decreased. If BTCPay Server or the end user wallet is compromised, the hardware wallet would sign two valid transactions, thus sending two payments.")]),e._v(" "),a("p",[e._v("Without payjoin, the maximum amount of money that could be lost by a compromised software is equal to one payment (via address substitution).")]),e._v(" "),a("p",[e._v("With payjoin, the maximum amount of money that can be lost is equals to two payments.")]),e._v(" "),a("h2",{attrs:{id:"future-work"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#future-work"}},[e._v("#")]),e._v(" Future work")]),e._v(" "),a("h3",{attrs:{id:"supporting-p2wpkh-and-p2sh-p2wpkh-for-the-same-store"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#supporting-p2wpkh-and-p2sh-p2wpkh-for-the-same-store"}},[e._v("#")]),e._v(" Supporting P2WPKH and P2SH-P2WPKH for the same store")]),e._v(" "),a("p",[e._v("In order to be useful, a sender and a receiver must share the same type of bitcoin address.")]),e._v(" "),a("p",[e._v("Ideally, this means that the receiver could adapt the invoice's payment address and contributed input to match the sender's orginal PSBT. In the context of BTCPay Server, this would mean that one merchant needs to setup two wallets for a single store. While this is theorically possible, this requires a big refactoring in our code and is not yet available.")]),e._v(" "),a("p",[e._v("Also, even in the event that we developed such feature, merchants are rarely technically apt to understand the reason of using two wallets for their store to accomodate such technical limitation.")]),e._v(" "),a("p",[e._v("Another proposition is to allow one wallet to support both, P2WPKH and P2SH-P2WPKH. But this is problematic as it is non standard so no wallet or tool supports fund recovery for such a type of wallet.")]),e._v(" "),a("p",[e._v("For now, we only support a single wallet for the store of the merchant, P2SH-P2WPKH or P2WPKH which are "),a("a",{attrs:{href:"https://transactionfee.info/charts/inputs-segwit-distribution/",target:"_blank",rel:"noopener noreferrer"}},[e._v("the most common type of inputs"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("This means that if the type does not match the sender's wallet type, the payjoin will not be created and the payment will fallback to a normal transaction.")]),e._v(" "),a("h3",{attrs:{id:"receiver-s-payment-batching"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#receiver-s-payment-batching"}},[e._v("#")]),e._v(" Receiver's payment batching "),a("a",{attrs:{name:"batching"}})]),e._v(" "),a("p",[e._v("Because the sender is not verifying the outputs of the payjoin transaction proposal, the receiver has the freedom to add output for payments they want to make.")]),e._v(" "),a("p",[e._v("Imagine Alice making transaction of 1 BTC to Bob. Bob decided he wanted to send 2 BTC to an exchange.\nWhen Alice is negotiating a payjoin, Bob can add 2 BTC in the outputs in addition to his inputs. In such way, he will economize fees.")]),e._v(" "),a("h3",{attrs:{id:"analysis-poisoning-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#analysis-poisoning-2"}},[e._v("#")]),e._v(" Analysis poisoning")]),e._v(" "),a("p",[e._v("While our protocol allows the receiver to change the output address in order to break some blockchain analysis heuristic, we are still not taking advantage of it.")]),e._v(" "),a("h3",{attrs:{id:"increasing-privacy-of-clients-using-bip69"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#increasing-privacy-of-clients-using-bip69"}},[e._v("#")]),e._v(" Increasing privacy of clients using BIP69 "),a("a",{attrs:{name:"bip69"}})]),e._v(" "),a("p",[e._v("Currently, the sender and the receiver we implemented in BTCPay Server does not make any guarantee on the order of inputs and outputs.")]),e._v(" "),a("p",[e._v("The main reason for the receiver to not order the inputs and outputs of the "),a("code",[e._v("payjoin transaction")]),e._v(" according to BIP69, is that it would make clear to a blockchain analyst that transactions not following BIP69 are not payjoin transactions.")]),e._v(" "),a("p",[e._v("However, some senders may implement BIP69. In order to improve their privacy, our receiver implementation should make an effort to follow BIP69 as well in such situation.")]),e._v(" "),a("p",[e._v("However, some concerns have been reported that this mean that the distributions of payjoin payments would slightly favor BIP69. This happen because a payjoin transaction compliant with BIP69 would happen in both cases: By chance when randomly ordering the payjoin inputs and outputs, but also by the fact the sender had a BIP69 compliant original transaction.")]),e._v(" "),a("p",[e._v("Existing wallets using BIP69: "),a("a",{attrs:{href:"https://github.com/spesmilo/electrum/commit/e2c05c2400399fe24ddacfe114673cd75b9ba3c1",target:"_blank",rel:"noopener noreferrer"}},[e._v("Electrum wallet"),a("OutboundLink")],1),e._v(" and "),a("a",{attrs:{href:"https://github.com/Samourai-Wallet/samourai-wallet-android#bip69",target:"_blank",rel:"noopener noreferrer"}},[e._v("Samourai Wallet"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("h2",{attrs:{id:"references"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[e._v("#")]),e._v(" References")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki",target:"_blank",rel:"noopener noreferrer"}},[e._v("BIP174: Partially Signed Bitcoin Transaction Format"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/bitcoin/bips/blob/master/bip-0069.mediawiki",target:"_blank",rel:"noopener noreferrer"}},[e._v("BIP69: Lexicographical Indexing of Transaction Inputs and Outputs"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki",target:"_blank",rel:"noopener noreferrer"}},[e._v("BIP79: Bustapay"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://transactionfee.info/charts/inputs-segwit-distribution/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Segwit input type distribution"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://docs.wasabiwallet.io/using-wasabi/ChangeCoins.html#spend-the-change-with-another-entity-where-you-don-t-mind-if-each-of-the-two-know-that-you-transact-with-the-other-entity",target:"_blank",rel:"noopener noreferrer"}},[e._v("Wasabi wallet: Privacy best practices on change coins"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://en.bitcoin.it/wiki/PayJoin",target:"_blank",rel:"noopener noreferrer"}},[e._v("Bitcoin wiki: Payjoin"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);